{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "c3347a5b_3acb92a8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 14,
      "author": {
        "id": 1019013
      },
      "writtenOn": "2023-07-25T12:35:59Z",
      "side": 1,
      "message": "Could you also mention what worked well with this CL?\n\nI tried this when it\u0027s in the user git, but NFC module constantly crashes because `casimir` doesn\u0027t send expected packets. Am I missing something?\n\nIf the constant crash is expected, we should wait and submit this CL later when it doesn\u0027t break anything.",
      "range": {
        "startLine": 14,
        "startChar": 6,
        "endLine": 14,
        "endChar": 15
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ee2efb68_7da9bb09",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 14,
      "author": {
        "id": 1884477
      },
      "writtenOn": "2023-07-25T12:49:41Z",
      "side": 1,
      "message": "With the full topic, you should be able to boot cuttlefish with Nfc enabled: see NFC emulator development notes. Let me know if you have any issues, it could be me forgetting to commit something again.",
      "parentUuid": "c3347a5b_3acb92a8",
      "range": {
        "startLine": 14,
        "startChar": 6,
        "endLine": 14,
        "endChar": 15
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "75743314_d571f6cc",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1019013
      },
      "writtenOn": "2023-07-25T12:35:59Z",
      "side": 1,
      "message": "This is not even declared in `/system/nfc`. It\u0027s not in [system/nfc/src/nci_packets.pdl](https://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:system/nfc/src/nci_packets.pdl?q\u003df:nci_packets.pdl%20VERSION_2_\u0026sq\u003drepo:googleplex-android%2Fplatform%2Fsuperproject%2Fmain%20b:main%20-f:%5Eprebuilts%20-f:amlogic%20-f:mediatek%20-f:qcom%20-f:broadcom%20-f:panasonic%20-f:linaro%20-f:samsung%20-f:%22%2Fnxp%2F%22%20-f:%22%2Fst%2F%22) nor [system/nfc/src/include/nfc_target.h](https://source.corp.google.com/h/android/platform/superproject/main/+/main:system/nfc/src/include/nfc_target.h;l\u003d157?q\u003df:system%2Fnfc%20symbol:NCI_VERSION_2_\u0026sq\u003drepo:android%2Fplatform%2Fsuperproject%2Fmain%20b:main\u0026ssfr\u003d1), and NFC module doesn\u0027t seem to handle it in [nfc_ncif_proc_reset_rsp](https://source.corp.google.com/h/android/platform/superproject/main/+/refs/heads/main:system/nfc/src/nfc/nfc/nfc_ncif.cc;l\u003d1703;drc\u003d8ea96e718c31f838d8af553b0492d33fa4155536;bpv\u003d0;bpt\u003d1)\n\nDo you also have a pending change in NFC module to support ToT? FYI, I tried `Version20` myself but NFC module still crashes. NFC module seems to be advanced bit more, though.\n\nIf I understand correctly, [nfc_ncif_proc_reset_rsp](https://source.corp.google.com/h/android/platform/superproject/main/+/main:system/nfc/src/nfc/nfc/nfc_ncif.cc;l\u003d1666?q\u003dnfc_stop_timer.*nci_wait_rsp_timer\u0026sq\u003drepo:android%2Fplatform%2Fsuperproject%2Fmain%20b:main) expects `CORE_RESET_NTF` but I couldn\u0027t find the code in this CL\u0027s `nci_packets.pdl`. Could you check if my understanding is correct?\n\nJust FYI, I often reference Linux\u0027 kernel\u0027s simple NFC rootcanal implementation ([nci_dev.c](https://source.corp.google.com/h/android/platform/superproject/main/+/main:external/linux-kselftest/tools/testing/selftests/nci/nci_dev.c;l\u003d361?q\u003dnci_dev.c\u0026sq\u003drepo:android%2Fplatform%2Fsuperproject%2Fmain%20b:main)) to take a look at raw packet values.. Hope this helps.",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62208f09_e8fff6af",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1884477
      },
      "writtenOn": "2023-07-25T12:49:41Z",
      "side": 1,
      "message": "1. I am not using the NCI specification in system/nfc/src/nci_packets.pdl, instead the one in system/tools/casimir/src. The main reason for this is to make it more practical to handle segmented packets, and disambiguate NCI OIDs. The older specification has inaccuracies in that aspect and shouldn\u0027t be used.\n\n2. The version V2.2 is the latest version of the specification, published 2021-07-29\n\n3. I don\u0027t have pending changes in the Nfc stack; can you share the crash logs please ?\n\n4. For the core reset notification: see point 1 :)",
      "parentUuid": "75743314_d571f6cc",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b41990b4_91839f69",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1019013
      },
      "writtenOn": "2023-07-25T14:27:44Z",
      "side": 1,
      "message": "\u003e I am not using the NCI specification in system/nfc/src/nci_packets.pdl, instead the one in system/tools/casimir/src. The main reason for this is to make it more practical to handle segmented packets, and disambiguate NCI OIDs. The older specification has inaccuracies in that aspect and shouldn\u0027t be used.\n\nI\u0027m not telling you about `casimir`\u0027s internal PDL definitions. I\u0027m only saying the problem in the NFC apex module. NFC apex module is the bridge between framework Java API and HAL, and also service as `DH` (a.k.a Device host) in `NCI` specification. NFC apex module can only understand up to version 2.0, so `casimir`\u0027s return would be simply ignored.\n\n\u003e The version V2.2 is the latest version of the specification, published 2021-07-29\n\nGlad that you\u0027d referenced the latest spec. But then could you ensure that rest (i.e. non-`casimir`) of the Android stack understand it?\n\n\u003e I don\u0027t have pending changes in the Nfc stack; can you share the crash logs please ?\n\nSee: http://gpaste/6625393472700416\n\nI collected this log based on your CLs here, but only enabled NFC log for richer information. NFC module keeps crashing endlessly, so I can\u0027t turn on NFC via Settings\u0027 UI.\n\nYour doc says that NFC stack is booting. What does that mean exactly? For others point of view, the viable status looks the same as the CF\u0027s old skeleton implementation.",
      "parentUuid": "62208f09_e8fff6af",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "006f8e23_d27aec27",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1884477
      },
      "writtenOn": "2023-07-25T14:47:53Z",
      "side": 1,
      "message": "\u003e NFC apex module can only understand up to version 2.0, so casimir\u0027s return\n\u003e would be simply ignored.\n\nI misunderstood your remark here. Looking at the code it might be complicated to support V2.1+ since the checks are hardcoded as \u003d\u003d. I will change the default in casimir to v2.0. You mention that the stack progresses further with this value, what is the difference ? \n\n\u003e I collected this log based on your CLs here, but only enabled NFC log for richer\n\u003e information. NFC module keeps crashing endlessly, so I can\u0027t turn on NFC via \n\u003e Settings\u0027 UI.\n\nHow do you start the cuttlefish instance ? Local or remote ?\n\n\u003e Your doc says that NFC stack is booting. What does that mean exactly? \n\nThe stack is performing NFCC initialization and starts a discovery (see the casimir trace in the doc).\n\n\u003e For others point of view, the viable status looks the same as the CF\u0027s old \n\u003e skeleton implementation.\n\nWhat do you mean by viable status ?",
      "parentUuid": "b41990b4_91839f69",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "589e367a_544be58f",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1884477
      },
      "writtenOn": "2023-07-25T15:06:05Z",
      "side": 1,
      "message": "For reference, a successful start trace: https://paste.googleplex.com/5516884412727296\n\nI am enabling additional logging by setting NFC_DEBUG_ENABLED\u003d1 in libnfc-nci.conf\n\nI am not seeing some logs related to the HAL setup in your trace, it could be an issue linked to the HAL.\n```\n07-25 14:51:53.686   166   166 I hwservicemanager: getTransport: Cannot find entry android.hardware.nfc@1.2::INfc/default in either framework or device VINTF manifest.\n07-25 14:51:53.688   166   166 I hwservicemanager: getTransport: Cannot find entry android.hardware.nfc@1.1::INfc/default in either framework or device VINTF manifest.\n07-25 14:51:53.689  1095  1588 D libEGL  : dlopen (libGLESv2_angle.so) success at 0x7507167f381b5d09\n07-25 14:51:53.698   166   166 I hwservicemanager: getTransport: Cannot find entry android.hardware.nfc@1.0::INfc/default in either framework or device VINTF manifest.\n07-25 14:51:53.700  1460  1460 I com.android.nfc: [0725/145153.700230:INFO:NfcAdaptation.cc(739)] NfcAdaptation::InitializeHalDeviceContext: INfcAidl::fromBinder returned\n07-25 14:51:53.700   426   426 D android.hardware.nfc: nfc_default_hal::nfc: get_config\n...\n```",
      "parentUuid": "006f8e23_d27aec27",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5a8f2e79_cb62c4d8",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1884477
      },
      "writtenOn": "2023-07-25T15:17:00Z",
      "side": 1,
      "message": "Thinking back to it, your trace seems truncated. Can you report the first crash occurence please ?",
      "parentUuid": "589e367a_544be58f",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "32e7f57e_4e997f48",
        "filename": "tools/casimir/src/controller.rs",
        "patchSetId": 1
      },
      "lineNbr": 78,
      "author": {
        "id": 1019013
      },
      "writtenOn": "2023-07-26T06:37:54Z",
      "side": 1,
      "message": "My apology; You\u0027re right and there\u0027s no crash. I didn\u0027t run your CLs with `-enable_host_nfc\u003d1`. And I run my HAL CLs with strict packet verification with `nci_packets.pdl` in `/system/nfc`. I verified twice that there\u0027s no crash at least.\n\nVINTF message seems to be a red-herring. I think that it\u0027s irrelevant with our work.\n\nBut still, we need to address Version issue here because simply changing version to 2.2 to 2.0 from casimir cause crash.",
      "parentUuid": "5a8f2e79_cb62c4d8",
      "range": {
        "startLine": 78,
        "startChar": 42,
        "endLine": 78,
        "endChar": 51
      },
      "revId": "d9363eb2ee06d4305ef17ee527ea7bf04ea18e3d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}